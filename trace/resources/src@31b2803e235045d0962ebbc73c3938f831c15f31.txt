import asyncio
from typing import Any
from playwright.async_api import async_playwright, Playwright

async def get_screenshot(page: Any) -> None:
    print("taking screenshot Whatsapp web...", flush=True)

    qr_canvas = page.locator('canvas[aria-label*="QR"]')

    print("get qr code screenshot...", flush=True)

    await qr_canvas.screenshot(path="./images/qr.png")

async def run_websocket(playwright):
    browser = await playwright.chromium.launch()
    # page = await browser.new_page()
    # On active la trace
    context = await browser.new_context()
    await context.tracing.start(screenshots=True, snapshots=True, sources=True)

    page = await context.new_page()
    # Gestionnaire d'Ã©vÃ©nement asynchrone
    def on_web_socket(ws):
        print(f"WebSocket ouvert : {ws.url}")
        # On utilise des lambdas ou des fonctions pour les messages
        ws.on("framesent", lambda frame: print(f"ðŸš€ EnvoyÃ© : {frame}"))
        ws.on("framereceived", lambda frame: print(f"ðŸ“¥ ReÃ§u : {frame}"))

    page.on("websocket", on_web_socket)

    await page.goto("https://websocket.org/echo.html")  # Exemple de site

    # On attend un peu pour laisser les Ã©changes se faire
    await asyncio.sleep(5)
    await context.tracing.stop(path="trace.zip")
    await browser.close()

async def run(playwright: Playwright):
    print("Launch Firefox...", flush=True)
    browser = await playwright.firefox.launch(headless=True)

    print("New page...", flush=True)
    page = await browser.new_page()

    print("Goto Whatsapp web...", flush=True)
    await page.goto("https://web.whatsapp.com/")

    print("âœ“âœ“âœ“ SUCCESS! Attente 5 secondes âœ“âœ“âœ“", flush=True)

    # Attendre 2 minutes
    await asyncio.sleep(5)

    await get_screenshot(page)

    await browser.close()


async def main():
    async with async_playwright() as playwright:
        # await run(playwright)
        await run_websocket(playwright)


asyncio.run(main())

# import asyncio
# from playwright.async_api import async_playwright, Playwright
#
#
# async def run(playwright: Playwright):
#     context = await playwright.request.new_context()
#
#     response = await context.get("https://api.github.com/users/microsoft")
#
#     print(f"Status: {response.status}")
#     print(f"Content-Type: {response.headers.get('content-type')}")
#
#     assert response.ok
#     assert response.status == 200
#
#     json_data = await response.json()
#     print(f"User login: {json_data['login']}")
#     print(f"User name: {json_data['name']}")
